#!/bin/bash
export MSYS_NO_PATHCONV=1
set -e

SCRIPT_HOME="$( cd "$( dirname "$0" )" && pwd )"

# =================================================================================================================
# Usage:
# -----------------------------------------------------------------------------------------------------------------
usage () {
  cat <<-EOF

  Usage: $0 {start|stop|build|rebuild|shell}

  Options:

  build - Build the docker images for the project.
          You need to do this first.

  start - Creates the application containers from the built images
          and starts the services based on the docker-compose.yml file.

          To start the services and connect them to a specific TOB API instance,
          inject the url for the API using the tob-url flag.

          Examples:
          $0 start
          $0 start THE_ORG_BOOK_BASE_URL=http://docker.for.win.localhost:56325/api/v1
          $0 start bc_registries          
          $0 start bc_registries THE_ORG_BOOK_BASE_URL=http://docker.for.win.localhost:56325/api/v1

  stop - Stops the services.  This is a non-destructive process.  The containers
         are not deleted so they will be reused the next time you run start.
         
  rebuild - Rebuild the docker images.  
EOF
exit 1
}
# -----------------------------------------------------------------------------------------------------------------
# Default Settings:
# -----------------------------------------------------------------------------------------------------------------
ALL_CONTAINERS="\
    bc_registries\
    worksafe_bc\
    ministry_of_finance\
    fraser_valley_health_authority\
    city_of_surrey\
    liquor_control_and_licensing_branch\
"
DEFAULT_CONTAINERS="bc_registries"
# -----------------------------------------------------------------------------------------------------------------
# Functions:
# -----------------------------------------------------------------------------------------------------------------
configureEnvironment () {
  for arg in $@; do
    case "$arg" in
      *=*)
        export ${arg}
        ;;  
    esac
  done  
  
  export THE_ORG_BOOK_BASE_URL=${THE_ORG_BOOK_BASE_URL-https://django-devex-von-dev.pathfinder.gov.bc.ca/api/v1}
}

getStartupParams() {
  CONTAINERS=""
  ARGS="--force-recreate"

  for arg in $@; do
    case "$arg" in
      *=*)
        # Skip it
        ;;  
      all)
        CONTAINERS+=" $ALL_CONTAINERS";;
     -*)
        ARGS+=" $arg";;
      *)
        CONTAINERS+=" $arg";;
    esac
  done

  if [ -z "$CONTAINERS" ]; then
    CONTAINERS="$DEFAULT_CONTAINERS"
  fi

  echo ${ARGS} ${CONTAINERS}
}

build() {
    echo -e "\nBuilding libindy image ..."
    docker build \
        -t 'libindy' \
        -f 'libindy/Dockerfile' \
        .

    echo -e "\nBuilding python-libindy image ..."
    docker build \
        -t 'python-libindy' \
        -f 'python-libindy/Dockerfile' \
        .

    echo -e "\nBuilding permitify image ..."
    docker build \
        -t 'permitify' \
        -f 'permitify/Dockerfile' \
        ..
}

rebuild() {
    echo -e "\nRebuilding libindy image ..."
    docker build \
        --no-cache \
        -t 'libindy' \
        -f 'libindy/Dockerfile' \
        .
    
    echo -e "\nRebuilding python-libindy image ..."
    docker build \
        --no-cache \
        -t 'python-libindy' \
        -f 'python-libindy/Dockerfile' \
        .

    echo -e "\nRebuilding permitify image ..."
    docker build \
        --no-cache \
        -t 'permitify' \
        -f 'permitify/Dockerfile' \
        ..
}

clean() {
    echo -e "\nRemoving libindy image ..."
    docker rmi -f 'libindy'

    echo -e "\nRemoving python-libindy image ..."
    docker rmi -f 'python-libindy'

    echo -e "\nRemoving permitify image ..."
    docker rmi -f 'permitify'

    echo -e "\nRemoving volumes ..."
    docker volume rm -f 'worksafe_bc_wallet'
    docker volume rm -f 'bc_registries_wallet'
    docker volume rm -f 'ministry_of_finance_wallet'
    docker volume rm -f 'fraser_valley_health_authority_wallet'
    docker volume rm -f 'city_of_surrey_wallet'
    docker volume rm -f 'liquor_control_and_licensing_branch_wallet'
}
# =================================================================================================================

pushd ${SCRIPT_HOME} >/dev/null

case "$1" in
  start)
      shift
      _startupParams=$(getStartupParams $@)
      configureEnvironment $@
      docker-compose up ${_startupParams}
    ;;
  stop)
      configureEnvironment
      docker-compose stop
    ;;
  build)
      build
    ;;
  rebuild)
      rebuild
    ;;
  shell)
      docker-compose run web bash
    ;;
  clean)
      clean
    ;;
  *)
      usage;;
esac

popd >/dev/null
